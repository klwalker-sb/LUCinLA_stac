
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>single-year classification &#8212; LUCinLA_stac</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="setting up new project" href="setting_up_new_project.html" />
    <link rel="prev" title="Using Jupyter Notebook to interact with data on cluster" href="Jupyter_Notebook.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      <img src="_static/cover.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">LUCinLA_stac</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Land-Use Change in Latin America (LUCinLA) Computing Guide
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Overview
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="General_framework.html">
   General framework
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Project_background.html">
   Project background
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Processing_overview.html">
   Processing overview
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Computer setup
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Connecting_to_cluster.html">
   Connecting to the ERI cluster
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="environment_setup.html">
   Setting up your remote environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Transfering_files.html">
   Transfering Files to/from cluster
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Processing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Processing.html">
   Processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Downloading.html">
   Downloading process
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Pre_Pipeline.html">
   Post-download processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Pipeline.html">
   Pipeline process
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Cleaning_files.html">
   cleaning files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Errors.html">
   troubleshooting errors
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Jupyter_Notebook.html">
   Using Jupyter Notebook to interact with data on cluster
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Classification
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   single-year classification
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  New project configuration
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="setting_up_new_project.html">
   setting up new project
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Computing resources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro_to_git.html">
   Intro to git
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="commandLine_bash.html">
   command line
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="vim.html">
   Vim
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="slurm.html">
   Slurm
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="editing_this_guide.html">
   To edit this guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="quebracho.html">
   quebracho
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Cited References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="bibliography.html">
   cited references
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/Classification_rf.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://klwalker-sb.github.io/LUCinLA_stac/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://klwalker-sb.github.io/LUCinLA_stac//issues/new?title=Issue%20on%20page%20%2FClassification_rf.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#building-a-single-year-random-forest-model-from-the-smoothed-time-series">
   Building a single-year random-forest model from the smoothed time-series:
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-1-choose-the-feature-model-variable-inputs-to-use-in-the-model">
     Step 1: Choose the feature model (variable inputs to use in the model)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#spectral-index-variables">
       spectral-index variables
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#singleton-variables">
       singleton variables
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#segmentation-variables">
       segmentation variables
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-2-make-variable-stack-for-model">
     Step 2: make variable stack for model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-3-make-variable-dataframe-for-all-sample-points">
     Step 3: make variable dataframe for all sample points
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-4-choose-sample-model-sample-points-to-use-in-training">
     Step 4: choose sample model (sample points to use in training)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-5-build-random-forest-model">
     Step 5: build random forest model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-5-inspect-optimize-the-model">
     Step 5: inspect/optimize the model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-6-classify-surface-to-produce-map">
     Step 6: classify surface to produce map
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-7-mosaic-into-map">
     Step 7: Mosaic into map
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="single-year-classification">
<span id="classification-rf"></span><h1>single-year classification<a class="headerlink" href="#single-year-classification" title="Permalink to this headline">¶</a></h1>
<p>================================================================================================================================</p>
<div class="section" id="building-a-single-year-random-forest-model-from-the-smoothed-time-series">
<h2>Building a single-year random-forest model from the smoothed time-series:<a class="headerlink" href="#building-a-single-year-random-forest-model-from-the-smoothed-time-series" title="Permalink to this headline">¶</a></h2>
<div class="section" id="step-1-choose-the-feature-model-variable-inputs-to-use-in-the-model">
<h3>Step 1: Choose the feature model (variable inputs to use in the model)<a class="headerlink" href="#step-1-choose-the-feature-model-variable-inputs-to-use-in-the-model" title="Permalink to this headline">¶</a></h3>
<p>Three types of features can be used in the model:</p>
<ol class="simple">
<li><p><em><strong>spectral-index stats (<code class="docutils literal notranslate"><span class="pre">si_vars</span></code>)</strong></em>: Summary statistics and phenological variables for the modelling year generated from smoothed time-series data for each selected spectral image</p></li>
<li><p><em><strong>singleton variables (<code class="docutils literal notranslate"><span class="pre">singleton_vars</span></code>)</strong></em>: Ancillary raster datasets covering the full AOI for a single point in time (can be constant or annual, but do not provide time-series data within a given year.)</p></li>
<li><p><em><strong>segmentation variables (<code class="docutils literal notranslate"><span class="pre">poly_vars</span></code>)</strong></em>: Outputs from segmentation model (or other object-extraction method), which, unlike singleton_vars, are already parsed by cell, but like singleton_vars, do not have a time-series element.</p></li>
</ol>
<p>Choose a unique <em><strong><code class="docutils literal notranslate"><span class="pre">feature_model</span></code></strong></em> name for the desired combination of features</p>
<p>Feature models are stored in the dictionary (<code class="docutils literal notranslate"><span class="pre">feat_mod_dict</span></code>) at “/home/downspout-cel/paraguay_lc/Feature_Models.json”.
This allows quick lookup by name of the feature set (spec_indices, si_vars, singleton_vars, and poly_vars) and the full band sequence of the resulting stack (in case the internal band names get stripped).</p>
<div class="section" id="spectral-index-variables">
<h4>spectral-index variables<a class="headerlink" href="#spectral-index-variables" title="Permalink to this headline">¶</a></h4>
<p>Spectral-index stats contain both an index component and a statistic component. For the index component, see <a class="reference external" href="#veg_indices">vegetation indices</a> for options. The default RF model uses all six indices that we generated smoothed time series for in the pipeline process (evi2, gcvi, wi, kndvi, nbr &amp; ndmi). Indices can be readily dropped from new models, but adding new indices will require running the ts pipeline step to generate time series data for the index for all cells involved.</p>
<p>The statistic component regards how the time-series data for a spectral index are to be summarized into a single value, for example from  summary statistics or phenological variables for the modelling year. The default RF model uses (Max,Min,Amp,Avg,CV,Std,Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec) but variables can readily be dropped or added for new models.</p>
<p>Note that the year is defined by the parameters <code class="docutils literal notranslate"><span class="pre">start_yr</span></code> and <code class="docutils literal notranslate"><span class="pre">start_mo</span></code>, such that it starts on the first of start_mo of start_yr (so a year can be 1/Jan-31/Dec, 1/Apr-31/Mar, 1/Jun-31/May, etc. to best align with the local crop calendar and avoid splitting the primary cropping cycle)</p>
<p>wet season and dry season are currently hard-coded as wet = 1/Nov-1/Apr and dry = 1/May-1/Oct for Paraguay.
Seasonal dates can be changed and new variables can be added within <code class="docutils literal notranslate"><span class="pre">ts_composite.py</span></code> of LUCinSA_helpers.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The final data stack is of type uint16. Any variable added needs to be of the same type or smaller. This means that it needs to contain only non-negaive integers with a max value of 65535.</p>
</div>
<p>Variable options:</p>
<ul class="simple">
<li><p><strong>maxv_yr / maxv_wet / maxv_dry</strong> = Maximum Value for year / wet season / dry season (=POS_value)</p></li>
<li><p>maxd_yr / maxd_wet / maxd_dry = Day of year of maximum value (informational only. Use Maxdc as variable)</p></li>
<li><p><strong>maxdc_yr / maxdc_wet / maxdc_dry</strong> = 100 * (Cosine + 1) of MaxDate(*2pi/360) (so that calendar is cyclical and 31 Jan is as close to 1 Dec as it is to 30 Jan)</p></li>
<li><p><strong>minv_yr / minv_wet / minv_dry</strong> = Minimum Value for year</p></li>
<li><p>mind_yr / mind_wet / mind_dry = Day of year of minimum value. (informational only. Use Mindc as variable)</p></li>
<li><p><strong>mindc_yr / mindc_wet / mindc_dry</strong> = 100 * (Cosine + 1) of MinDate(*2pi/360) (so that calendar is cyclical and 31 Jan is as close to 1 Dec as it is to 30 Jan)</p></li>
<li><p><strong>amp_yr / amp_wet / amp_dry</strong> = Amplitude across year / wet season / dry season = (Max-Min)</p></li>
<li><p><strong>avg_yr / avg_wet / avg_dry</strong> = Mean Value for year / wet season / dry season</p></li>
<li><p><strong>sd_yr / sd_wet / sd_dry</strong> = Standard Deviation for year / wet season / dry season</p></li>
<li><p><strong>cv_yr / cv_wet / cv_dry</strong> =  Coefficient of Variation = (1000 * sd/avg) for yr / wet season / dry season</p></li>
<li><p><strong>Jan_20</strong> = Value for smoothed time series on 20 Jan</p></li>
<li><p><strong>Feb_20</strong> = Value for smoothed time series on 20 Feb</p></li>
<li><p>… etc.</p></li>
<li><p><strong>Dec_20</strong> = Value for smoothed time series on 20 Dec</p></li>
</ul>
<p>pheno_vars:</p>
<ul class="simple">
<li><p><strong>sosd_wet / sosd_dry</strong> = day of Start of Season, defined as observation closest to the median along the positive slope to the max value</p></li>
<li><p><strong>sosv_wet / sosv_dry</strong> = value at Start of Season</p></li>
<li><p><strong>eosd_wet / eods_dry</strong> day of End of Season, defined as observation closest to the median along the negative slope from the max value</p></li>
<li><p><strong>eosv_wet / eodv_dry</strong> = value at End of season</p></li>
<li><p><strong>los_wet / los_dry</strong> Length of Season, defined as the number of days between the Start and End of Season (eos-sos)</p></li>
<li><p><strong>rog_wet / rog_dry</strong> Rate of Greenup = (maxv - sosv) / (maxd - sosd)</p></li>
<li><p><strong>ros_wet / ros_dry</strong> = Rate of Senescing = (maxv = eosv) / (eosd - maxd)</p></li>
</ul>
<p><img alt="alt" src="_images/ts_pheno.jpg" />
SOS = (sosd, sosv) EOS = (eosd, eosv), POS = (posd, posv)</p>
</div>
<div class="section" id="singleton-variables">
<h4>singleton variables<a class="headerlink" href="#singleton-variables" title="Permalink to this headline">¶</a></h4>
<p>Singleton variables are ancillary raster datasets covering the whole area and time period. The only singleton variable currently available is <code class="docutils literal notranslate"><span class="pre">forest_strata</span></code>, which provides vegetational ecozones (“estratos_corregidos2014_6” – TODO: get citation info from Ata).</p>
<p>A dictionary for singleton variables exists at: “/home/downspout-cel/paraguay_lc/singleton_var_dict.json”
This contains the name of the variable, path to the dataset, and name of the attribute to use.
To add another singleton variable, simply add the dataset at the desired location in the shared folder and add the data (manually) to the dictionary.</p>
</div>
<div class="section" id="segmentation-variables">
<h4>segmentation variables<a class="headerlink" href="#segmentation-variables" title="Permalink to this headline">¶</a></h4>
<p>Segmentation variables are outputs and summary variables from the segmentation process (TODO: link to segmentation processing description). Current variables are:</p>
<ul class="simple">
<li><p><strong>pred_area</strong> = Area of field</p></li>
<li><p><strong>pred_dist</strong> = Distance from edge of field (inner only)</p></li>
<li><p><strong>pred_ext</strong> = Likelihood of pixel belonging to a crop field (10,000 = very likely. Anything less = less sure)</p></li>
<li><p><strong>pred_APR</strong> = Area to perimeter ratio</p></li>
<li><p><strong>AvgNovDec_FieldStd</strong> = Standard deviation for whole field for Nov and Dec (averaged across dates)</p></li>
</ul>
</div>
</div>
<div class="section" id="step-2-make-variable-stack-for-model">
<h3>Step 2: make variable stack for model<a class="headerlink" href="#step-2-make-variable-stack-for-model" title="Permalink to this headline">¶</a></h3>
<p>This stacks all variables into a single data stack for each cell, which makes for more efficient calculations (especially at the point of surface-level classification)</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Making a physical variable stack can be computationally expensive (up to 1 GB stored data per cell and 1-2 GB temp data in backup limbo (unless using scratch_dir option). The stack does not need to be physically made if there is an existing stack that contains all of the desired bands. Steps 3 and 5 have option to build a smaller virtual stack based on a larger data stack.</p>
</div>
<p>Run <code class="docutils literal notranslate"><span class="pre">LUCinSA_helpers</span> <span class="pre">make_var_stack</span></code> using the configuration in the Bash Script, <code class="docutils literal notranslate"><span class="pre">rf0_raster_var_stack.sh</span></code></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--in_dir</span></code> is the path to the main time-series directory (i.e.: “/home/raid-cel/r/downspout-cel/paraguay_lc/stack/grids”)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--cell_list</span></code> is the list of cells to run. This can be single cell fed from the SBATCH array line or a path to a single .csv file or folder containg .csv files with the list of cells to run (no header). With the later option, the files can then be named numerically and run in an array via the SBATCH line. (examples are given in <code class="docutils literal notranslate"><span class="pre">rf0_raster_var_stack.sh</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--start_yr</span></code> is the year of the mapping period (first year if the cropping calendar spans two years).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--start_mo</span></code> is the first month of the corpping calendar, in numerical form (1 if calendar is Jan-Dec. 6 if calendar is Jun-May)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--feature_model</span></code> is the name of the feature model (defining the spec_vars, si_vars, singleton_vars and poly_vars). this is stored in the * <code class="docutils literal notranslate"><span class="pre">--feature_mod_dict</span></code> is the path to the dictionary containing all feature models. If the feature model does not already exist, it will be added to the dictionary based on the parameters here. If it already exists, the parameters here will be filled with those already set in the dictionary)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--spec_indices</span></code> the set of vegetation index to include (e.g [evi2,wi,gcvi,kndvi,ndmi,nbr] or a smaller subset. If passed from BASH script, needs to be list inside string (e.g: “[var1,var2,var3]”)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--si_vars</span></code> sets the raster variables to include for the spec indices. ([max, min, …]) To maintain structure and avoid confusion, the same set of si_vars should be used for all vegetation indices used in the model. (This dataset can be culled at step 4.) If passed from BASH script, needs to be list inside string (e.g: “[var1,var2,var3]”)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pheno_vars</span></code> the set of season specific phenological variables to incude (e.g. [sosd_wet, eosd_wet, los_wet, …]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--spec_indices_pheno</span></code> the set of vegetation indices to get phenological variables for</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--singleton_vars</span></code> is the set of singleton rasters to include (e.g. [‘forest_strata’])</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--singleton_var_dict</span></code> is the path to the dictionary defining all singleton layers (e.g. “/home/downspout-cel/paraguay_lc/singleton_var_dict.json”)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--poly_vars</span></code> is the list of segmentation variables to include (if passed from BASH script, needs to be list inside string (e.g: “[var1,var2,var3]”)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--poly_path</span></code> is the path to the folder containing the segmentation variables (e.g. “/home/downspout-cel/paraguay_lc/Segmentations/RF_feats/”)</p></li>
<li><p>–<code class="docutils literal notranslate"><span class="pre">combo_vars</span></code> is a list of all components (spec index + si_var) of any remaining variables that have not already been included. This is in case a particular variable should be included for only a single index or subset of indices. (e.g. evi2_cv_year)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--scratch_dir</span></code> is an optional path to the scratch directory (to save storage with processing temp files (which may be tied uo in lengthy backup period in time series directory))</p></li>
</ul>
<p>These same sets of spec_indices, si_var, singleton_vars, and poly_vars should be used to make the variable dataframe in the next step.</p>
</div>
<div class="section" id="step-3-make-variable-dataframe-for-all-sample-points">
<h3>Step 3: make variable dataframe for all sample points<a class="headerlink" href="#step-3-make-variable-dataframe-for-all-sample-points" title="Permalink to this headline">¶</a></h3>
<p>To extract the value of each raster variable to each sample point and construct the dataframe used to build the random forest model, run <code class="docutils literal notranslate"><span class="pre">LUCinSA_helpers</span> <span class="pre">make_var_dataframe</span></code> via the Bash script: <code class="docutils literal notranslate"><span class="pre">rf1_var_data_frame.sh</span></code>.</p>
<p>The sample data can either be in point or polygon form, indicated by whether <code class="docutils literal notranslate"><span class="pre">--Load_samp</span></code> is True.</p>
<ul class="simple">
<li><p>If points:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">--load_samp</span></code> is set to True</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--ptfile</span></code> is used to supply the path to the point file, which needs to be in the form of .csv with and ‘OID_’ column containing unique identifiers for each point (as integers) and ‘XCoord’ and ‘YCoord’columns containing the x and y coordinates in the same coordinate system as grid_file</p></li>
</ul>
</li>
<li><p>if polygons:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">--load_samp</span></code> is set to False</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--ground_polys</span></code> is used to supply the path to the polygon file. The polygon file should be a shapefile or geopackage.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--newest</span></code> and <code class="docutils literal notranslate"><span class="pre">--oldest</span></code> can be used to filter polygons to those from a certain year or set of years based on an attribute in the polygon file with any of the following labels: ‘FirstYrObs’,’ObsYr’,’Year’ or ‘Acquired’ (if ‘Acquired, it can be in the form YYYYMMDD). –newest and –oldest can be the same year if only a single year is desired. If no year filter is desired, set –newest and –oldest to 0.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--npts</span></code> sets the number of random points that are drawn from each polygon. The variable data will be extracted to these points, and the output will then be a dataframe, as with a point sample.</p></li>
</ul>
</li>
</ul>
<p>other parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--in_dir</span></code> is the path to the main time-series directory (i.e.: “/home/raid-cel/r/downspout-cel/paraguay_lc/stack/grids”)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--out_dir</span></code> is the path to the folder in which to store the output dataframe</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--cell_list</span></code> are the cells within which to search for points/polygons. This can be either a list of unique cell ids or a path to a .csv file containing the list (no header). This helps narrow the search and reduce time, but can be broad (if a cell on the list does not contain sample data, it is skipped over).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--grid_file</span></code> is the path to the file containing the geographic info for the</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--feature_model</span></code> is the name of the feature model (the same used in step 2 above, used to find the stored variable stack)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--start_yr</span></code> is the first year of the mapping period (the same used in step 2 above, used here to find the stored variable stack)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--feature_model_dict</span></code>is the path to the dictionary with the feature model, to look up the band order (e.g. “/home/downspout-cel/${COUNTRY}_lc/Feature_Models.json”)</p></li>
</ul>
</div>
<div class="section" id="step-4-choose-sample-model-sample-points-to-use-in-training">
<h3>Step 4: choose sample model (sample points to use in training)<a class="headerlink" href="#step-4-choose-sample-model-sample-points-to-use-in-training" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Notebook</span> <span class="pre">6b</span></code></p>
<ul class="simple">
<li><p>class balance</p></li>
<li><p>percent test/train</p></li>
<li><p>poly-based augmentation</p></li>
</ul>
</div>
<div class="section" id="step-5-build-random-forest-model">
<h3>Step 5: build random forest model<a class="headerlink" href="#step-5-build-random-forest-model" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">LUCinSA_helpers</span> <span class="pre">rf_model</span></code> uses <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html">RandomForestClassifier from scikit-learn</a><span id="id1">[<a class="reference internal" href="bibliography.html#id11">Pedregosa <em>et al.</em>, 2011</a>]</span> to fit a random forest model to the variable dataframe. Prior to fitting the model, 20% of the training data is held out to be used for model inspection in the next step (this is separate from any data held out for final map validation). The final model is saved in the <code class="docutils literal notranslate"><span class="pre">--out_dir</span></code> as {model_name}_RFmod.joblib</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--df_in</span></code> is the path to the variable dataframe created in Step 3 (and modified in step 4).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--feature_model</span></code> is the same feature model name from steps 2-4 above (used here to create a consistent model name)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--sample_model</span></code> is a unique name for the sample model created in step 4 above (used here as part of the model name)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--start_yr</span></code> is the year of the mapping period (used here as the third part of the model name)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--importance_method</span></code> sets how feature importances are to be calculated. If <code class="docutils literal notranslate"><span class="pre">importance_method='Impurity'</span></code>, the default feature importances from the sklearn rf model are returned. If <code class="docutils literal notranslate"><span class="pre">importance_method='Permutation'</span></code>, a permutation test is run to calculate feature importances. As long as <code class="docutils literal notranslate"><span class="pre">importance_method</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">'None'</span></code>, the feature improtances are returned in the <code class="docutils literal notranslate"><span class="pre">--out_dir</span></code> as ‘VarImportance_{model_name}.csv’</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--ran_hold</span></code> is an integer that can be used as a constant seed to hold randomization methods constant between different runs of a given model (for reproducibility). (NOTE: This is not working at the moment; repeated runs of the same model do give different results)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--lut</span></code> points to the lookup table with the numeric and descriptive labels for classes. Our LUT can be referenced (or downloaded) from the main directory of LUCinSA_helpers as <code class="docutils literal notranslate"><span class="pre">LUT.txt</span></code> (an abbreviated copy is provided [here](# TODO LINK THIS) for reference)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--lc_mod</span></code> indicates the classification system to to be used. Our full model <code class="docutils literal notranslate"><span class="pre">Lc_mod='All'</span></code> uses the 25 classes in the <code class="docutils literal notranslate"><span class="pre">LC25</span></code> column of the LUT. (Note that this is the classification system used during model building – more detailed classes can always be regrouped to show less detail following model-building/classification, but not vice-versa.)
Current classification models are:
* <strong>crop_nocrop = LC2</strong>: a two-class model for crop/nocrop
* <strong>crop_nocrop_medcrop = LC3</strong>: a three class model for crop/nocrop/medcrop,
* <strong>crop_nocrop_medcrop_tree = LC4</strong>: a four class model for crop/nocrop/medcrop/tree
* <strong>veg’ = LC5</strong>: a five class model for vegetation type (noveg/lowveg/medveg/highveg/mature)
* <strong>cropType = LC_crops</strong>: a model with specific crop classes and nocrop.
* <strong>class models can be added</strong> by adding a column to the LUT and a correspoinding line to the <code class="docutils literal notranslate"><span class="pre">get_class_col</span></code> function in <code class="docutils literal notranslate"><span class="pre">rf.py</span></code>. All unique ids (<code class="docutils literal notranslate"><span class="pre">LC_UNQ</span></code> column) must have a corresponding value in the class column. If a category should be excluded from training (e.g. because it is not specific enough), assigning a value of 99 will cause points from that category to be dropped from the dataframe prior to modelling.</p></li>
</ul>
</div>
<div class="section" id="step-5-inspect-optimize-the-model">
<h3>Step 5: inspect/optimize the model<a class="headerlink" href="#step-5-inspect-optimize-the-model" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Notebook</span> <span class="pre">6c</span></code></p>
</div>
<div class="section" id="step-6-classify-surface-to-produce-map">
<h3>Step 6: classify surface to produce map<a class="headerlink" href="#step-6-classify-surface-to-produce-map" title="Permalink to this headline">¶</a></h3>
<p>once a model has been selected, a single-year map can be created using <code class="docutils literal notranslate"><span class="pre">LUCinSA_helpers</span> <span class="pre">rf_classification</span></code></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--in_dir</span></code> is the path to the main time-series directory (i.e.: “/home/raid-cel/r/downspout-cel/paraguay_lc/stack/grids”)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--df_in</span></code> is the path to the variable dataframe created in Step 3 (and modified in step 4)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--feature_model</span></code> is the same feature model name from steps 2-5 above (used here to create a consistent model name)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--sample_model</span></code> is a unique name for the sample model from steps 4-5 above (used here as part of the model name)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--start_yr</span></code> is the year of the mapping period (used here as the third part of the model name)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--cell_list</span></code> is the list of cells to run. This can be single cell fed from the SBATCH array line or a path to a single .csv file or folder containg .csv files with the list of cells to run (no header). With the later option, the files can then be named numerically and run in an array via the SBATCH line. (examples are given in <code class="docutils literal notranslate"><span class="pre">rf3_classify_image.sh</span></code>).</p></li>
<li><p>optinal parametters from step 5 can be included if the rf model has not already been built</p></li>
<li><p>optional parameters from step 2 can be included if variable stacks should be made for cells without stacks (i.e those that are not part of the sample)</p></li>
</ul>
</div>
<div class="section" id="step-7-mosaic-into-map">
<h3>Step 7: Mosaic into map<a class="headerlink" href="#step-7-mosaic-into-map" title="Permalink to this headline">¶</a></h3>
<p>After classifying each desired cell, the cells can be mosaicked together into a single geotiff using: <code class="docutils literal notranslate"><span class="pre">LUCinSA_helpers</span> <span class="pre">mosaic</span></code></p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="Jupyter_Notebook.html" title="previous page">Using Jupyter Notebook to interact with data on cluster</a>
    <a class='right-next' id="next-link" href="setting_up_new_project.html" title="next page">setting up new project</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Kendra Walker<br/>
        
            &copy; Copyright 2023.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>