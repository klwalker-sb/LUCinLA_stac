
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pipeline process &#8212; LUCinLA_stac</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using Jupyter Notebook to interact with data on cluster" href="Jupyter_Notebook.html" />
    <link rel="prev" title="Post-download processing" href="Pre_Pipeline.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      <img src="_static/cover.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">LUCinLA_stac</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Land-Use Change in Latin America (LUCinLA) Computing Guide
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Overview
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="General_framework.html">
   General framework
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Project_background.html">
   Project background
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Processing_overview.html">
   Processing overview
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Computer setup
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Connecting_to_cluster.html">
   Connecting to the ERI cluster
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="environment_setup.html">
   Setting up your remote environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="TransferingFiles.html">
   Transfering Files to/from cluster
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Processing
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Processing.html">
   Processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Downloading.html">
   Downloading process
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Pre_Pipeline.html">
   Post-download processing
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Pipeline process
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Jupyter_Notebook.html">
   Using Jupyter Notebook to interact with data on cluster
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  New project configuration
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Setting_up_new_project.html">
   Setting up a new project
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Computing resources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro_to_git.html">
   Intro to git
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="commandLine_bash.html">
   command line
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="vim.html">
   Vim
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="slurm.html">
   Slurm
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/Pipeline.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://klwalker-sb.github.io/LUCinLA_stac/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://klwalker-sb.github.io/LUCinLA_stac//issues/new?title=Issue%20on%20page%20%2FPipeline.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#index-options-lines-11-15">
   index options (lines 11-15):
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-options-for-vegetation-indices">
     other options for vegetation indices:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-the-process">
   Run the process
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#check-result">
   Check result
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-grid-pipeline-status">
   Get grid pipeline status
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="pipeline-process">
<span id="pipeline"></span><h1>Pipeline process<a class="headerlink" href="#pipeline-process" title="Permalink to this headline">¶</a></h1>
<p>======================================================================</p>
<p>The pipeline process is driven by the <code class="docutils literal notranslate"><span class="pre">pytuyau</span></code> script <a class="reference external" href="https://github.com/jgrss/pytuyau#readme">see here</a> for more information on the script process.</p>
<p>We are currently using only two processes in our image prep: coregistration (STEP=”preprocess”) and time series (STEP=”reconstruct”)
First run the coregistration script (eostac_pipe_py.sh)
Then run the time-series script (eostac_pipe_ts_py.sh)  for each index you need processed</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The CEL drive space on the cluster is setup such that all products through co-registration saved on the sandbox space (<code class="docutils literal notranslate"><span class="pre">raid-cel/sandbox/sandbox-cel</span></code> or just <code class="docutils literal notranslate"><span class="pre">/home/sandbox-cel</span></code>). These files are not backed up for more than 10 days (if you lose important files, you can probably get them recovered within 10 days, but not after). Time series outputs and beyond are saved to the downspout space (<code class="docutils literal notranslate"><span class="pre">raid-cel/r/downspout-cel</span></code> or just <code class="docutils literal notranslate"><span class="pre">/home/downspout-cel</span></code>), which has a separate long term backup.</p>
</div>
<p><strong>To run the coregistration step:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">code</span><span class="o">/</span><span class="n">bash</span>
<span class="n">vim</span> <span class="n">eostac_pipe_py</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1-  #!/bin/bash -l

2-  #SBATCH -N 1 # number of nodes
3-  #SBATCH -n 2 # number of cores
4-  #SBATCH -t 0-08:00 # time (D-HH:MM)
5-  #SBATCH -p basic 
6-  #SBATCH -o stacpipe_crg.%N.%a.%j.out # STDOUT
7-  #SBATCH -e stacpipe_crg.%N.%a.%j.err # STDERR
8-  #SBATCH --job-name=&quot;stpipe_crg&quot;
9-  #SBATCH --array=86

10- GRIDS=&quot;$(($SLURM_ARRAY_TASK_ID + 4000))&quot;

   #############################################
   # Turn off NumPy parallelism and rely on dask
   #############################################
11-  export OPENBLAS_NUM_THREADS=1
12-  export MKL_NUM_THREADS=1
13-  # This should be sufficient for OpenBlas and MKL
14-  export OMP_NUM_THREADS=1
   ################################################

15-  STEP=&quot;preprocess&quot;
16-  SAT_SENSORS=S2,S2cp,LT05,LE07,LC08,LC09
18-  NCHUNKS=512

   ###############################
   # DO NOT MODIFY BELOW THIS LINE
   ###############################

   # activate the virtual environment
19-  conda activate venv.lucinsa38_pipe

20-  CONFIG_UPDATES=&quot;grids:[${GRIDS}] res:${REF_RES} crs:${REF_CRS} 
21-  cloud_mask:sat_sensors:${SAT_SENSORS}
22-  main_path:/raid-cel/sandbox/sandbox-cel/paraguay_lc/stac/grid
23-  backup_path:/raid-cel/r/downspout-cel/paraguay_lc/stac/grids
24-  num_workers:${SLURM_CPUS_ON_NODE} 
25-  io:n_chunks:${NCHUNKS} cloud_mask:reset_db:${RESET_CLOUD_DB} 
26-  cloud_mask:ref_res:${REF_RES}&quot;

27-  tuyau $STEP --config-updates $CONFIG_UPDATES

28-  conda source deactivate
</pre></div>
</div>
<p>Most lines should stay as they are.<br />
<strong>the lines that you need to change are:</strong>\</p>
<ul class="simple">
<li><p><strong>Grid info:</strong> <code class="docutils literal notranslate"><span class="pre">#SBATCH</span> <span class="pre">--array=</span></code> (line 9 here). This is where you enter the gridcells you are processing.<br />
You can enter a range (e.g. 898-908), But be mindful that you are not hogging all the computer bandwidth.</p></li>
</ul>
<div class="admonition-you-can-limit-the-number-of-cells-that-are-processed-at-one-time-by-adding-n admonition">
<p class="admonition-title">You can limit the number of cells that are processed at one time by adding %n</p>
<p>For example, 898-908%4 would process 4 cells at a time. When the first 4 finish, the next will start.</p>
</div>
<p><strong>To run the time series step:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">code</span><span class="o">/</span><span class="n">bash</span>
<span class="n">vim</span> <span class="n">eostac_pipe_ts_py</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1- #!/bin/bash -l

2- #SBATCH -N 1 # number of nodes
3- #SBATCH -n 8 # number of cores
4- #SBATCH -t 0-08:00 # time (D-HH:MM)
5- #SBATCH -p basic 
6- #SBATCH -o stacpipe_ts.%N.%a.%j.out # STDOUT
7- #SBATCH -e stacpipe_ts.%N.%a.%j.err # STDERR
8- #SBATCH --job-name=&quot;stpipe_ts&quot;
9- #SBATCH --array=957,958

10- GRIDS=&quot;$(($SLURM_ARRAY_TASK_ID + 3000))&quot;

11- #VIs=(&quot;evi2&quot;)
12- VIs=(&quot;gcvi&quot; &quot;wi&quot;)
13- #VIs=(&quot;evi2&quot; &quot;gcvi&quot; &quot;wi&quot;)
14- #VIs=(&quot;kndvi&quot; &quot;nbr&quot; &quot;ndmi&quot;)
15- #VIs=(&quot;evi2&quot; &quot;gcvi&quot; &quot; wi&quot; &quot; kndvi&quot; &quot;nbr&quot; &quot;ndmi&quot;)

    #############################################
    # Turn off NumPy parallelism and rely on dask
    #############################################
16- export OPENBLAS_NUM_THREADS=1
17- export MKL_NUM_THREADS=1
18- # This should be sufficient for OpenBlas and MKL
19- export OMP_NUM_THREADS=1
    ################################################

21-  METHOD=&#39;STAC&#39;
22-  STEP=&quot;reconstruct&quot;
23-  SAT_SENSORS=S2,S2cp,LT05,LE07,LC08,LC09
24-  NCHUNKS=512

    #############
    # RECONSTRUCT
    #############
25- RINPUT=&quot;ms&quot;
26- START_PAD=&quot;2000-01-01&quot;
27- START=&quot;2010-04-01&quot;
28- END_PAD=&quot;2022-12-01&quot;
29- END=&quot;2022-09-01&quot;
30- SKIP_INTERVAL=1
31- SKIP_YEARS=10
32- ROVERWRITE=&quot;False&quot;
33- SM_CHUNKS=512
34- PREFILL_GAPS=&quot;False&quot;
35- DTS_MAX_WIN=61
36- DTS_MIN_WIN=15
37- PREFILL_YEARS=2
38- DTS_t=5

    ###############################
    # DO NOT MODIFY BELOW THIS LINE
    ###############################

    # activate the virtual environment
39- conda activate venv.lucinsa38_pipe

    # Do for each index:
40- for VI in &quot;${VIs[@]}&quot;
41- do

42-   CONFIG_UPDATES=&quot;grids:[${GRIDS}] res:${REF_RES} crs:${REF_CRS} 
      cloud_mask:sat_sensors:${SAT_SENSORS}
      main_path:/raid-cel/sandbox/sandbox-cel/paraguay_lc/stac/grid
      backup_path:/raid-cel/r/downspout-cel/paraguay_lc/stac/grids
      dlMehod:${METHOD}
      num_workers:${SLURM_CPUS_ON_NODE} 
      io:n_chunks:${NCHUNKS} cloud_mask:reset_db:${RESET_CLOUD_DB} 
      reconstruct:input:${RINPUT} reconstruct:start_pad:${START_PAD} 
      reconstruct:end_pad:${END_PAD} reconstruct:start:${START} reconstruct:end:${END} 
      reconstruct:skip_interval:${SKIP_INTERVAL} reconstruct:skip_years:${SKIP_YEARS}
      reconstruct:vi:${VI} reconstruct:overwrite:${ROVERWRITE} reconstruct:chunks:${SM_CHUNKS}
      reconstruct:smooth_kwargs:max_window:${DTS_MAX_WIN}
      reconstruct:smooth_kwargs:min_window:${DTS_MIN_WIN}
      reconstruct:smooth_kwargs:prefill_max_years:${PREFILL_YEARS}
      reconstruct:smooth_kwargs:prefill_gaps:${PREFILL_GAPS} reconstruct:smooth_kwargs:t:${DTS_t}
      clean:remove_items:${REMOVE_ITEMS}&quot;

43-   tuyau $STEP --config-updates $CONFIG_UPDATES

44- done
14- conda deactivate
</pre></div>
</div>
<div class="section" id="index-options-lines-11-15">
<h2>index options (lines 11-15):<a class="headerlink" href="#index-options-lines-11-15" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>To run a preliminary check, start with evi2</p></li>
<li><p>For segmention inputs, we are using evi2, gcvi and wi</p></li>
<li><p>For final classification, we are using evi2, gcvi, wi, kndvi, nbr &amp; ndmi</p></li>
</ul>
<div class="section" id="other-options-for-vegetation-indices">
<h3>other options for vegetation indices:<a class="headerlink" href="#other-options-for-vegetation-indices" title="Permalink to this headline">¶</a></h3>
<p>Current options for vegetation indices are:</p>
<ul class="simple">
<li><p>avi = ?? (removed?)</p></li>
<li><p>evi2 = 2.5 * ( NIR - RED) / ( NIR + 2.4 * RED + 1.0 )</p>
<ul>
<li><p>Enhanced Vegetation Index, good for areas of high LAI (leaf-area index), where NDVI tends to saturate</p></li>
</ul>
</li>
<li><p>gcvi= scaled index using Green &amp; NIR</p>
<ul>
<li><p>Green Chlorophyll Vegetation Index, useful for crop classification</p></li>
</ul>
</li>
<li><p>kndvi= tanh(( NIR - RED) / ( NIR + 2.4 * RED + 1.0 ))^2)</p>
<ul>
<li><p>See <a class="reference external" href="https://www.science.org/doi/10.1126/sciadv.abc7447">Camps-Valls et al 2021, A unified vegetation index for quantifying the terrestrial biosphere</a></p></li>
</ul>
</li>
<li><p>nbr = (NIR - SWIR2) / (NIR + SWIR2) + 1e-9)</p>
<ul>
<li><p>Normalized Burn Index</p></li>
</ul>
</li>
<li><p>wi = 0 if (red + SWIR1) &gt; 0.5, else 1.0 - ((red + SWIR1) / 0.5))</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To add a new vegetation index to the code, edits need to be made to both the <code class="docutils literal notranslate"><span class="pre">vis.py</span></code> and <code class="docutils literal notranslate"><span class="pre">check_reconstruction.py</span></code> scripts in <code class="docutils literal notranslate"><span class="pre">~/tmp/pytuyau/pytuyau/steps</span></code>.
ie, to add NDVI:
in <code class="docutils literal notranslate"><span class="pre">check_reconstruction.py</span></code> around line 169, add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;reconstruct&#39;</span><span class="p">][</span><span class="s1">&#39;vi&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ndvi&#39;</span><span class="p">:</span>
    <span class="n">band_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span> 
</pre></div>
</div>
<p>in <code class="docutils literal notranslate"><span class="pre">vis.py</span></code> around line 6, add name or your index to the list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AVAIL_VIS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;avi&#39;</span><span class="p">,</span> <span class="s1">&#39;evi2&#39;</span><span class="p">,</span> <span class="s1">&#39;gcvi&#39;</span><span class="p">,</span> <span class="s1">&#39;kndvi&#39;</span><span class="p">,</span> <span class="s1">&#39;nbr&#39;</span><span class="p">,</span> <span class="s1">&#39;wi&#39;</span><span class="p">,</span><span class="s1">&#39;ndvi&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>in <code class="docutils literal notranslate"><span class="pre">vis.py</span></code> around line 27 add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;reconstruct&#39;</span><span class="p">][</span><span class="s1">&#39;vi&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ndvi&#39;</span><span class="p">:</span>
    <span class="n">vi_data</span> <span class="o">=</span> <span class="n">data_src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">ndvi</span><span class="p">(</span><span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>in <code class="docutils literal notranslate"><span class="pre">vis.py</span></code> under other index methods (around line 75) add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ndvi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>(note that <code class="docutils literal notranslate"><span class="pre">_norm</span></code> is defined above that as <code class="docutils literal notranslate"><span class="pre">(b2</span> <span class="pre">-</span> <span class="pre">b1)</span> <span class="pre">/</span> <span class="pre">((b2</span> <span class="pre">+</span> <span class="pre">b1)</span> <span class="pre">+</span> <span class="pre">1e-9)</span></code> there are currently another option of<br />
<code class="docutils literal notranslate"> <span class="pre">_scale_min_max:</span> <span class="pre">((((max_out</span> <span class="pre">-</span> <span class="pre">min_out)</span> <span class="pre">*</span> <span class="pre">(xv</span> <span class="pre">-</span> <span class="pre">min_in))</span> <span class="pre">/</span> <span class="pre">(max_in</span> <span class="pre">-</span> <span class="pre">min_in))</span> <span class="pre">+</span> <span class="pre">min_out)\</span> <span class="pre">.clip(min_out,</span> <span class="pre">max_out)</span></code>, or can
create a different equation without self argument (use <code class="docutils literal notranslate"><span class="pre">&#64;staticmethod</span></code> on line above index definition)</p>
<p>After modifying script, reinstall:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~</span>
<span class="n">source</span> <span class="o">.</span><span class="n">nasaenv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">cd</span> <span class="n">tmp</span><span class="o">/</span><span class="n">pytuyau</span>
<span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">build</span> <span class="o">&amp;&amp;</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">.</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="run-the-process">
<h2>Run the process<a class="headerlink" href="#run-the-process" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#if not already in bash directory, navigate there:
cd ~/code/bash/
#submit the command:
sbatch pipeline_eri.sh
</pre></div>
</div>
<p>Current run-time estimates for single grid cells:
* Preprocess : 1-2hrs &#64;2cores
* Reconstruct: 1-2hrs &#64;8cores per index
* Segment
* Classify
* Assess
* Clean</p>
</div>
<div class="section" id="check-result">
<h2>Check result<a class="headerlink" href="#check-result" title="Permalink to this headline">¶</a></h2>
<p>You can make a composite image with <code class="docutils literal notranslate"><span class="pre">MakeTSComposite.sh</span></code>
TODO: add instructions regarding LUCinSA_helpers</p>
<p><img alt="alt" src="_images/Composite.jpg" /></p>
</div>
<div class="section" id="get-grid-pipeline-status">
<h2>Get grid pipeline status<a class="headerlink" href="#get-grid-pipeline-status" title="Permalink to this headline">¶</a></h2>
<p>XXX —Currently not using ———————————————-</p>
<p>To generate the Pipeline Progress figure:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#Activate virtual environment:
source .nasaenv/bin/activate
#Run status command:
tuyau status --config-updates status:project_path:/raid-cel/sandbox/sandbox-cel/paraguay_lc/raster/grids status:out_path:&lt;PNG location&gt; status:grid_file:/raid-cel/sandbox/sandbox-cel/paraguay_lc/vector/pry_grids.gpkg status:zoom:True
#Deactivate virtual environment:
deactivate
</pre></div>
</div>
<p>To view the Processing Progress figure:
Download file to view on local computer:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rsync -raz --progress &lt;username&gt;@ssh.eri.ucsb.edu:&lt;ERI path&gt; &lt;local path&gt;
</pre></div>
</div>
<p>Alternatively, you can view the file though an FPT such as WinSCP.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="Pre_Pipeline.html" title="previous page">Post-download processing</a>
    <a class='right-next' id="next-link" href="Jupyter_Notebook.html" title="next page">Using Jupyter Notebook to interact with data on cluster</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Kendra Walker<br/>
        
            &copy; Copyright 2023.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>